function buildEquipSelectOption(){let e=["tw","cn","en","jp"];lan_eq_nation.forEach(e=>{e.name=`equip_nation_${e.id}`}),lan_eq_type.forEach(e=>{e.name=`equip_type_${e.id}`,e.display=!1}),lan_eq_rarity.forEach(t=>{t.name=`equip_rarity_${t.id}`,e.forEach(e=>t[e]=t.en)}),lan_eq_tier.forEach(t=>{t.name=`equip_tier_${t.id}`,e.forEach(e=>t[e]=`${t.id}`)}),setTimeout(()=>window.buildEquipSelectOption=null)}function buildShipSelectOption(){let e=["tw","cn","en","jp"];lan_ship_nation.forEach(t=>{t.name=`ship_nation_${t.id}`,t.tw=t.cn,e.forEach(e=>t[`${e}_code`]=t[e])}),lan_ship_type.forEach(t=>{t.name=`ship_type_${t.id}`,t.display=!1,t.tw=t.cn,e.forEach(e=>t[`${e}_code`]=t[e])}),lan_ship_rarity.forEach(t=>{t.name=`ship_rarity_${t.id}`,e.forEach(e=>t[e]=t.code)}),setTimeout(()=>window.buildShipSelectOption=null)}const lan_target_list=[{id:"allow_dup_btn",en:"Allow Duplicate",jp:"重複を許可する",tw:"允許重複的船"},{id:"layout_label",en:"Layout:",jp:"スタイル:",tw:"排版方式:"},{id:"display_fleet_border",en:"Fleet Border",jp:"フレーム表示",tw:"顯示外框"},{id:"display_fleet_op",en:"Fleet ID / Edit Button",jp:"編集ボタン表示",tw:"顯示編輯"},{id:"frame_setting",en:"Thick frame",jp:"厚いフレーム",tw:"粗框"},{id:"add_fleet",en:"Save Current",jp:"現在の艦隊をセーブ",tw:"儲存目前艦隊"},{id:"select_fleet",en:"Select Fleet",jp:"艦隊を選択",tw:"選擇艦隊"},{id:"load_fleet",en:"Load Fleet",jp:"ロード",tw:"載入艦隊"},{id:"remove_fleet",en:"Delete",jp:"削除",tw:"刪除"},{id:"fleet_name_label",en:"Fleet Name",jp:"艦隊名",tw:"艦隊名"},{id:"emptyfleet",en:"Empty Current Fleet",jp:"現在の艦隊を空に",tw:"清空目前艦隊"},{id:"fleetdata_text",en:"Fleet data",jp:"艦隊データ",tw:"艦隊資料"},{id:"dumpdata",en:"Dump",jp:"ダンプ",tw:"匯出"},{id:"copyData",en:"Copy",jp:"コピー",tw:"複製"},{id:"emptyData",en:"Clear",jp:"クリア",tw:"清空"},{id:"loadDataByID",en:"Load",jp:"ロード",tw:"載入"},{id:"rebuild_cache_btn",en:"Rebuild Cache",jp:"キャッシュをクリア&再構築",tw:"重建快取"},{id:"select_ship",en:"Select Ship",jp:"艦船を選択",tw:"選擇艦船"},{id:"filter_nation",en:"Nation",jp:"陣営",tw:"國家"},{id:"filter_type",en:"Type",jp:"種類",tw:"種類"},{id:"filter_rarity",en:"Rarity",jp:"レア度",tw:"稀有度"},{id:"sort",en:"Sorting",jp:"並べ替え",tw:"排序"},{id:"sort_nation",en:"Nation",jp:"陣営",tw:"國家"},{id:"sort_type",en:"Type",jp:"種類",tw:"種類"},{id:"sort_rarity",en:"Rarity",jp:"レア度",tw:"稀有度"},{id:"sort_default",en:"Default",jp:"初期設定",tw:"預設"},{id:"sort_retro",en:"Retrofit",jp:"改造",tw:"改造"},{id:"sort_jp",en:"Name(JP)",jp:"名前(JP)",tw:"名稱(JP)"},{id:"sort_en",en:"Name(EN)",jp:"名前(EN)",tw:"名稱(EN)"},{id:"sort_tw",en:"Name(TW)",jp:"名前(TW)",tw:"名稱(TW)"},{id:"sort_cn",en:"Name(CN)",jp:"名前(CN)",tw:"名稱(CN)"},{id:"search_input",en:"Search",jp:"検索",tw:"搜尋"},{id:"filter_search_result",en:"Result",jp:"結果",tw:"結果"},{id:"filter_retro",en:"Retrofitted Only",jp:"改造された艦船だけ",tw:"只顯示改造後的"},{id:"select_equip",en:"Select Equip",jp:"装備を選択",tw:"選擇裝備"}],vue_ui_text={sub_fleet:{en:"Sub",jp:"潜水",tw:"潛艇",cn:"潛艇"},normal_fleet:{en:"Normal",jp:"通常",tw:"一般",cn:"一般"},copy_fleet:{en:"Copy",jp:"コピー",tw:"複製",cn:"複製"},swap_ship:{en:"Swap",jp:"交換",tw:"交換",cn:"交換"}},parsetype={1:{cn:"驅逐砲",en:"DD Gun",jp:"駆逐砲"},2:{cn:"輕巡砲",en:"CL Gun",jp:"軽巡砲"},3:{cn:"重巡砲",en:"CA Gun",jp:"重巡砲"},4:{cn:"戰艦砲",en:"BB Gun",jp:"戦艦砲"},5:{cn:"魚雷",en:"Torpedoe",jp:"魚雷"},6:{cn:"防空砲",en:"Anti-Air Gun",jp:"対空砲"},7:{cn:"戰鬥機",en:"Fighter",jp:"戦闘機"},8:{cn:"攻擊機",en:"Torpedo Bomber",jp:"攻撃機"},9:{cn:"爆擊機",en:"Dive Bomber",jp:"爆撃機"},10:{cn:"設備",en:"Auxiliary",jp:"設備"},11:{cn:"超巡砲",en:"CB Gun",jp:"超巡砲"},12:{cn:"水上機",en:"Seaplane",jp:"水上機"},13:{cn:"潛艇魚雷",en:"Submarine Torpedoe",jp:"潜水艦魚雷"},14:{cn:"爆雷",en:"Depth Charge",jp:"爆雷"},15:{cn:"反潛機",en:"ASW Bomber",jp:"対潜機"},17:{cn:"直升機",en:"ASW Helicopter",jp:"ヘリ"},18:{cn:"貨物",en:"Cargo",jp:"積載"}};Object.keys(parsetype).forEach(e=>parsetype[e].tw=parsetype[e].cn);const lan_ship_nation=[{id:1,cn:"白鷹",en:"Eagle Union",jp:"ユニオン",code:"USS"},{id:2,cn:"皇家",en:"Royal Navy",jp:"ロイヤル",code:"HMS"},{id:3,cn:"重櫻",en:"Sakura Empire",jp:"重桜",code:"IJN"},{id:4,cn:"鐵血",en:"Iron Blood",jp:"鉄血",code:"KMS"},{id:5,cn:"東煌",en:"Dragon Empery",jp:"東煌",code:"PRAN/ROC"},{id:6,cn:"撒丁帝國",en:"Sardegna Empire",jp:"サディア",code:"RN"},{id:7,cn:"北方聯合",en:"Northern Parliament",jp:"北連",code:"SN"},{id:8,cn:"自由鳶尾",en:"Iris Libre",jp:"アイリス",code:"FFNF"},{id:9,cn:"維希教廷",en:"Vichya Dominion",jp:"ヴィシア",code:"MNF"},{id:0,cn:"其他",en:"Other",jp:"その他",code:"Other"}],lan_ship_type=[{id:8,cn:"潛艇",en:"Submarine",jp:"潜水艦",code:"SS",pos:"sub"},{id:17,cn:"潛母",en:"Submarine Carrier",jp:"潜水空母",code:"SSV",pos:"sub"},{id:1,cn:"驅逐",en:"Destroyer",jp:"駆逐",code:"DD",pos:"front"},{id:2,cn:"輕巡",en:"Light Cruiser",jp:"軽巡",code:"CL",pos:"front"},{id:3,cn:"重巡",en:"Heavy Cruiser",jp:"重巡",code:"CA",pos:"front"},{id:18,cn:"超巡",en:"Large Cruiser",jp:"超甲巡",code:"CB",pos:"front"},{id:4,cn:"戰巡",en:"Battle Cruiser",jp:"巡洋戦艦",code:"BC",pos:"back"},{id:5,cn:"戰列",en:"Battle Ship",jp:"戦艦",code:"BB",pos:"back"},{id:6,cn:"輕航",en:"Light Carrier",jp:"軽空母",code:"CVL",pos:"back"},{id:7,cn:"航母",en:"Aircraft Carrier",jp:"空母",code:"CV",pos:"back"},{id:13,cn:"重砲",en:"Monitor",jp:"砲艦",code:"BM",pos:"back"},{id:12,cn:"維修",en:"Repair Ship",jp:"工作",code:"AR",pos:"back"},{id:0,cn:"其他",en:"Other",jp:"その他",code:"Other"}],lan_ship_rarity=[{id:6,cn:"海上傳奇",en:"Ultra Rare",jp:"UR",code:"★★★★★★"},{id:5,cn:"超稀有",en:"SuperRare",jp:"SSR",code:"★★★★★"},{id:4,cn:"精銳",en:"Elite",jp:"SR",code:"★★★★"},{id:3,cn:"稀有",en:"Rare",jp:"R",code:"★★★"},{id:2,cn:"普通",en:"Normal",jp:"N",code:"★★"}];buildShipSelectOption();const lan_eq_type=Object.keys(parsetype).map(e=>e=Object.assign({id:e},parsetype[e])),lan_eq_nation=lan_ship_nation.map(e=>Object.assign({},e)),lan_eq_tier=[{id:0},{id:3},{id:2},{id:1}],lan_eq_rarity=[{id:6,en:"★★★★★★"},{id:5,en:"★★★★★"},{id:4,en:"★★★★"},{id:3,en:"★★★"},{id:2,en:"★★"}];buildEquipSelectOption(),Object.defineProperty(Array.prototype,"isAll",{value:function(){return this.every(e=>Boolean(e))}}),Object.defineProperty(Array.prototype,"sameAs",{value:function(e){if(!(e instanceof Array))throw Error(`[${e}] (${typeof e}) is not Array!!`);return JSON.stringify(this)===JSON.stringify(e)}});const settingKey={language:"language",fleetData:"fleetData",allowDup:"allowDup",thickFrame:"thickFrame",layout:"layout",fleetEdit:"fleetEdit",fleetBorder:"fleetBorder"},util={sleep:(e=0)=>new Promise(t=>setTimeout(t,e)),indexInObj(e,t=!1){let n=[];if(t)for(let t in e)n.push(t,e[t]);else for(let t in e)n.push(t);return n},sorting(e,t,n){function i(e,t){return String(e).localeCompare(String(t),navigator.languages[0]||navigator.language,{numeric:!0})}return n?e.sort((e,n)=>i(n[t],e[t])):e.sort((e,n)=>i(e[t],n[t])),e},stringifyReplacer(e,t){if("string"==typeof t){if(""==t)return 0;{let e=parseInt(t,10);return e||t}}return t},changeButtonStats(e,t=!0){function n(){e.click(),e.classList.add("active"),e.setAttribute("aria-pressed",!0)}function i(){e.click(),e.classList.remove("active"),e.setAttribute("aria-pressed",!1)}t?e.classList.contains("active")||n():e.classList.contains("active")&&i()}},LS={userSetting:{prefix:"user_setting_",set(e,t){if(e.match(/fleet_index_/))throw Error("Invalid Key");AFL_storage.setItem(`${this.prefix}${e}`,t),console.log(`save key:[${e}], value:[${t}]`)},get(e){return AFL_storage.getItem(`${this.prefix}${e}`)},del(e){return AFL_storage.removeItem(`${this.prefix}${e}`)}},fleetManager:{fleetLength(){let e=this.getData("num_of_fleet");return e||0},storageFleetData(e=[]){let t=e.length;if(!(e instanceof Array))throw Error("fleet data is not Array");if(!t)throw Error("no fleet data");for(let n=1;n<=t;n++)this.setData(`fleet_index_${n}`,e[n-1]);return this.setData("num_of_fleet",t),console.log(`storage ${t} fleet data`),!0},clearFleetData(){let e=this.fleetLength();for(let t=1;t<=e;t++)this.remove(`fleet_index_${t}`);return this.remove("num_of_fleet"),console.log(`remove ${e} old fleet data`),!0},getData(e){let t=AFL_storage.getItem(e);return t?JSON.parse(t):null},setData(e,t){let n=JSON.stringify(t);return AFL_storage.setItem(e,n)},remove:e=>AFL_storage.removeItem(e)},updateStorageList(){let e=fleet_info.list();e.innerHTML=fleet_in_storage.length>0?"":'<div class="dropdown-item text-light text-monospace" id="no_fleet">no fleet in storage...</div>',fleet_in_storage.forEach((t,n)=>{let i=decodeURIComponent(t.name),a=document.createElement("div");a.className="dropdown-item text-light text-monospace",a.textContent=`${n}_[${i}]`,a.onclick=function(){let e=fleet_info.select();e.textContent=`${n}_[${i}]`,e.setAttribute("sotrge_id",n),fleet_info.load().disabled=!1,fleet_info.remove().disabled=!1},e.appendChild(a)})},saveStorage(){let e=fleet_in_storage.length;e&&(LS.fleetManager.clearFleetData(),LS.fleetManager.storageFleetData(fleet_in_storage))},add_fleet(){let e=fleet_info.name(),t=e.value.trim(),n=encodeURIComponent(t);if(t&&0!=t.length){let t=app.util.dumpID();fleet_in_storage.push({name:n,fleet:t}),LS.saveStorage(),msg.normal.storage_add_fleet(n),e.value=""}else msg.error.empty_name()},load_fleet(){let e=fleet_info.select().getAttribute("sotrge_id");e&&!isNaN(e)||msg.error.invalid_id();let t=fleet_in_storage[e];t||msg.error.no_data();let n=decodeURIComponent(t.name);msg.normal.storage_load_fleet(e,t.name),fleet_info.name().value=n,LS.clear_select();let i=document.getElementById("fleetdata");i.value=t.fleet,app.util.loadDataByID()},clear_select(){let e=fleet_info.select();e.textContent="Select Fleet",e.removeAttribute("sotrge_id"),fleet_info.load().disabled=!0,fleet_info.remove().disabled=!0},remove_fleet(){let e=fleet_info.select().getAttribute("sotrge_id");e&&!isNaN(e)||msg.error.invalid_id();let t=fleet_in_storage[e];t||msg.error.no_data(),msg.normal.storage_remove_fleet(e,t.name),LS.clear_select(),fleet_in_storage.splice(e,1),LS.saveStorage()}},initialDB=async(e,t)=>{const n=await idb.openDB(e,t,{upgrade(t,n,i){try{n&&t.objectStoreNames.length&&i>n&&(console.log("clear old version"),t.deleteObjectStore(e))}catch(e){console.log(t,n,i,e)}finally{t.createObjectStore(e,{keyPath:"id"})}}}),i={getImgCache:async(t="")=>(await n).get(e,t),setImgCache:async(t="",i="")=>(await n).put(e,i,t),clear:async()=>(await n).clear(e),allKeys:async()=>(await n).getAllKeys(e)};return[n,i]},emptyCache=async()=>{const[e,t]=await initialDB(db_name,db_ver);await t.clear(),window.location.reload()},msg={error:{_t:(e="")=>fleet_info.msg.red("Error: "+e),delete_last(){return this._t("You can't delete the last Fleet")},maximum_fleet(){return this._t("Exceed maximum Fleet limit")},negative_position(){return this._t("Position must be positive")},unknown_direction(){return this._t("Unknown direction")},empty_name(){return this._t("Fleet name is empty")},invalid_id(){return this._t("Invalid Fleet id")},no_data(){return this._t("Fleet data is empty")},long_url(){return this._t("URL too long. You still can share it by use fleetdata below")},too_high(){return this._t("Can't yeet the Fleet higher than it is")},too_low(){return this._t("Can't yeet the Fleet lower than it is")},unzip_failed(){return this._t("Invalid data")},corrupted_data(){return this._t("Corrupted data")},unknown_version(){return this._t("Unknown version")}},normal:{_t:(e="")=>fleet_info.msg.green(e),storage_add_fleet(e){return this._t(`Fleet [${decodeURIComponent(e)}] Saved`)},storage_load_fleet(e,t){return this._t(`Fleet ${e} [${decodeURIComponent(t)}] loaded`)},storage_remove_fleet(e,t){return this._t(`Fleet ${e} [${decodeURIComponent(t)}] removed`)},storage_found_fleets(e){return this._t(`Found ${e} Fleet in storage`)},copied(){return this._t("Copied")},fleet_dump(){return this._t("Fleet data dumped")},fleet_copied(e){return this._t(`Fleet ${e+1} copied`)},fleet_removed(e){return this._t(`Fleet ${e+1} removed`)},fleet_added(e){return this._t(`New ${1==e?"Normal":"Submarine"} Fleet added`)},fleet_loaded(){return this._t("Successfully loaded Fleet data")}}},fleet_info={name:()=>document.querySelector("#fleet_name"),select:()=>document.querySelector("#select_fleet"),list:()=>document.querySelector("#fleet_list"),load:()=>document.querySelector("#load_fleet"),remove:()=>document.querySelector("#remove_fleet"),msg:{red(e="",t=!0){let n=document.querySelector("#error_message");if(classManager.exchange(n,msg_color.green,msg_color.red),n.textContent=e,n.style.opacity=1,this.clear_queue(),this.queue.push(setTimeout(()=>{n.style.opacity=0},3e3)),t)throw Error(e)},green(e="",t=!0){let n=document.querySelector("#error_message");classManager.exchange(n,msg_color.red,msg_color.green),n.textContent=e,n.style.opacity=1,this.clear_queue(),this.queue.push(setTimeout(()=>{n.style.opacity=0},3e3)),t&&console.log(e)},clear_queue(){this.queue.forEach(e=>clearTimeout(e))},queue:[]}},classManager={exchange(e,t,n){e.classList.contains(t)&&e.classList.remove(t),e.classList.add(n)},batchExchange(e,t,n){(t&&n)instanceof Array&&(t&&n).length>0&&(t.forEach(t=>e.classList.remove(t)),n.forEach(t=>e.classList.add(t)))}},app={option:{setLanguage(e){let t=e.id;language=ALF.lang=shipSelect.lang=equipSelect.lang=t,document.querySelectorAll("[name=name]").forEach(e=>e.textContent=e.getAttribute(t)),document.querySelectorAll("[ui_text='true']").forEach(e=>{"INPUT"==e.tagName?e.placeholder=e.getAttribute(`ui_${t}`):e.textContent=e.getAttribute(`ui_${t}`)}),LS.userSetting.set(settingKey.language,language),this.adjustEle()},switchLayout(e,t=!1){function n(n,a){i(t?n:a),e.textContent=layout_list[t?n:a]}function i(e=""){for(let t in appClassData)"app_box"==t?document.querySelector(".app_box").className=`${appClassData.app_box[e]} app_box`:ALF.class_data[t]=appClassData[t][e]}switch(e.textContent){case layout_list.h:n("h","v");break;case layout_list.v:n("v","v2");break;case layout_list.v2:n("v2","h");break;default:throw Error("unknown layout")}LS.userSetting.set(settingKey.layout,layout_list[e.textContent])},frameSize(e){function t(e=""){if(e!=i)return 0,n?e.match(a)?e.replace(a,".png"):e.replace(".png","b.png"):e.replace(a,".png");0}$(e).button("toggle");let n="true"==e.getAttribute("aria-pressed"),i=window.location.href,a=/b+\.png/;[sortedEquip,sortedShip].forEach(e=>{e.forEach(e=>{""!=e.frame&&(e.frame=t(e.frame))})}),document.querySelectorAll("img.frame").forEach(e=>{""!=e.currentSrc&&(e.src=t(e.currentSrc))}),LS.userSetting.set(settingKey.thickFrame,n?1:0)},displayOP(e){$(e).button("toggle");let t=!!e.classList.contains("active");ALF.show_op=t,LS.userSetting.set(settingKey.fleetEdit,t?1:0)},displayBorder(e){$(e).button("toggle");let t=layout_list[document.querySelector("#layout_setting").textContent],n=e.classList.contains("active");if(n){const e={fleet_box_o:{h:"fleet_box_o d-grid justify-content-center",v:"fleet_box_o d-grid border border-secondary",v2:"fleet_box_o flex-row"},fleet_box_i:{h:"fleet_box_i row m-2 border border-secondary",v:"fleet_box_i col p-0",v2:"fleet_box_i col p-0 border border-secondary"}};for(let n in e)appClassData[n]=e[n],ALF.class_data[n]=appClassData[n][t]}else{const e={fleet_box_o:{h:"fleet_box_o d-grid justify-content-center",v:"fleet_box_o d-grid",v2:"fleet_box_o flex-row"},fleet_box_i:{h:"fleet_box_i row m-2",v:"fleet_box_i col p-0",v2:"fleet_box_i col p-0"}};for(let n in e)appClassData[n]=e[n],ALF.class_data[n]=appClassData[n][t]}LS.userSetting.set(settingKey.fleetBorder,n?1:0)},adjustEle(){const e=$(window).width(),t=1300,n={exchange:"exchange",batch:"batchExchange",w25:"w-25",w50:"w-50",w100:"w-100",mw100:"mw-100",no_effect:"adjustEle_placeholder",df:"d-flex",fw:"flex-wrap"},i=(e,t,n,i)=>({mode:t,n:n,s:i,ele:document.getElementById(e)}),a=[["option_box_1",n.exchange,n.w25,n.w50],["option_box_2",n.exchange,n.w25,n.w50],["fleet_storage",n.exchange,n.w50,n.w100],["dialog_shipselect",n.exchange,n.no_effect,n.mw100],["dialog_select_equip",n.exchange,n.no_effect,n.mw100]];e<t?a.forEach(e=>{e=i(...e),classManager[e.mode](e.ele,e.n,e.s)}):a.forEach(e=>{e=i(...e),classManager[e.mode](e.ele,e.s,e.n)})},ship:{allow_dup(e){$(e).button("toggle"),LS.userSetting.set(settingKey.allowDup,e.classList.contains("active")?1:0)},setCode(e){$(e).button("toggle");let t=["tw","cn","en","jp"];[lan_ship_nation,lan_ship_type].forEach(e=>{e.forEach(e=>{t.forEach(t=>{let n=e[t],i=e.code;e[t]=n==i?e[`${t}_code`]:e.code})})})},setRetro(e){$(e).button("toggle"),retrofit_only=e.classList.contains("active"),app.shipDisplay()},sort_order(e){e.value=1==e.value?0:1,e.textContent=1==e.value?"⮟":"⮝"},isDescend(){return this._sort_order||(this._sort_order=document.querySelector("#ship_sort_order")),1==this._sort_order.value},last_sort:{},sort(e,t=!1){let n=document.querySelector("#shiplist"),i="000000",a=sortedShip[0],o=(this.last_sort.list?this.last_sort.list:sortedShip).filter(e=>e.id!=i),l=e.getAttribute("value"),r=this.isDescend();console.log(`sort by:${l}, descend:${r}`),t?o=sortedShip:(o=util.sorting(o,l,r),o.unshift(a)),o.forEach(e=>n.appendChild(n.querySelector(`[id="${e.id}"]`))),this.last_sort={key:l,descend:r,list:o}}},equip:{resetFilter(e=!1){const t=new Set(e?[6,5,4,3]:[]),n=new Set(e?[0,3]:[]);document.querySelectorAll("#eq_tier button").forEach(e=>util.changeButtonStats(e,!!n.has(parseInt(e.value,10)))),document.querySelectorAll("#eq_rarity button").forEach(e=>util.changeButtonStats(e,!!t.has(parseInt(e.value,10)))),document.querySelectorAll("#eq_nation button,#eq_type button").forEach(e=>util.changeButtonStats(e,!1)),filter_setting.eq_type=new Set,filter_setting.eq_nation=new Set,filter_setting.eq_rarity=t,filter_setting.eq_tier=n},setCode(e){$(e).button("toggle");let t=["tw","cn","en","jp"];[lan_eq_nation].forEach(e=>{e.forEach(e=>{t.forEach(t=>{let n=e[t],i=e.code;e[t]=n==i?e[`${t}_code`]:e.code})})})},autoUseDefault(e){$(e).button("toggle"),e.classList.contains("active")?this.resetFilter(!0):this.resetFilter(!1)},sort_order(e){e.value=1==e.value?0:1,e.textContent=1==e.value?"⮟":"⮝"},isDescend(){return this._sort_order||(this._sort_order=document.querySelector("#equip_sort_order")),1==this._sort_order.value},last_sort:{},sort(e,t=!1){let n=document.querySelector("#equiplist"),i="666666",a=sortedEquip[0],o=(this.last_sort.list?this.last_sort.list:sortedEquip).filter(e=>e.id!=i),l=e.getAttribute("value"),r=this.isDescend();console.log(`sort by:${l}, descend:${r}`),t?o=sortedEquip:(o=util.sorting(o,l,r),o.unshift(a)),o.forEach(e=>n.appendChild(n.querySelector(`[id="${e.id}"]`))),this.last_sort={key:l,descend:r,list:o}}}},fleet:{buildFleet(e=[],t=!1){if(!e.length)throw Error("formation data is empty!!");let n=[];const i={1:e=>this.newNormalFleet(e),2:e=>this.newSubFleet(e)};if(e.forEach((e,t)=>n.push(i[e](t))),c_formation=e,!t)return n;ALF.fleets=fleetData=n},creatEmptyShip(){let e=[];for(let t=0;t<6;t++){let n=[];if(0===t){let e={id:"",type:"",star:"",rarity:"",tw:"",en:"",cn:"",jp:"",icon:ui_table.empty_item,bg:"",frame:"",target:"#shipselect",base:[],quantity:""};n=e}else{let e={id:"",type:[],star:"",rarity:"",tw:"",en:"",cn:"",jp:"",icon:ui_table.empty_disable,bg:"",frame:"",target:"",fb:[],type_tw:"",type_cn:"",type_en:"",type_jp:"",limit:"",quantity:""};n=e}e.push({id:t,property:[]}),e[t].property=Object.assign({},n)}return e},newNormalFleet(e){if(isNaN(e)||e<0)throw Error("no fleet_id");let t=[],n=[],i=this.creatEmptyShip(),a=i.length;for(let o=0;o<6;o++)if(o<3){let n=[];for(let t=0;t<a;t++){let a=Object.assign({},i[t].property);0==t&&(a.ship_pos=posTable.F[o]),a.pos="front",n.push({id:`${e}_0_${o}_${t}`,property:a})}t.push({id:`fleet_${e}_front_${o}`,item:n})}else{let t=[];for(let n=0;n<a;n++){let a=Object.assign({},i[n].property);0==n&&(a.ship_pos=posTable.BS[o-3]),a.pos="back",t.push({id:`${e}_1_${o-3}_${n}`,property:a})}n.push({id:`fleet_${e}_back_${o-3}`,item:t})}return{id:`Fleet ${e+1}`,front:t,back:n}},newSubFleet(e){if(isNaN(e)||e<0)throw Error("no fleet_id");let t=[],n=this.creatEmptyShip();for(let i=0;i<3;i++){let a=[],o=n.length;for(let t=0;t<o;t++){let o=Object.assign({},n[t].property);0==t&&(o.ship_pos=posTable.BS[i]),o.pos="sub",a.push({id:`${e}_2_${i}_${t}`,property:o})}t.push({id:`fleet_${e}_sub_${i}`,item:a})}return{id:`Fleet ${e+1}`,sub:t}}},util:{removeAllCookie(){function e(e,t="",n=-1){let i=new Date,a=new Date;a.setTime(i.getTime()+1e3*n*60*60*24),document.cookie=`${e}=${t};expires=${a.toUTCString()};SameSite=Strict;`}let t=document.cookie,n={},i=new Set(["expires","SameSite"]);t=t.split(";").map(e=>e.trim()),t.forEach(e=>{let[t,a]=e.split("=");i.has(t)||(n[t]=a)});for(let t in n)e(t)},isCorrectShipType:e=>!("0"===c_side&&!type_front.has(e))&&(!("1"===c_side&&!type_back.has(e))&&!("2"===c_side&&!type_sub.has(e))),async updateFilter(e,t,n){let i=filter_setting[e].has(t),a=(e,t)=>filter_setting[e].add(t),o=(e,t)=>filter_setting[e].delete(t),l=(e,t)=>i?o(e,t):a(e,t);if(0!=t)l(e,t);else if(0==t)if("type"==n){let e=["front","back","sub"];i?e.forEach(e=>o(e,0)):e.forEach(e=>a(e,0))}else l(e,0);return!0},async updateSetting(e){$(e).button("toggle");let t=e.name.split("_"),n=t[0],i=t[1],a=parseInt(t[2],10);if("ship"==n){if("nation"===i)await this.updateFilter("nation",a,i);else if("type"===i)switch(c_side){case"0":await this.updateFilter("front",a,i);break;case"1":await this.updateFilter("back",a,i);break;case"2":await this.updateFilter("sub",a,i);break;default:throw Error(`unknown ship type ${i}`)}else"rarity"===i&&(await this.updateFilter("rarity",a,i),e.style.color=e.style.color.length>0?"":"gold");app.shipDisplay()}else if("equip"==n){switch(i){case"nation":await this.updateFilter("eq_nation",a,i);break;case"type":await this.updateFilter("eq_type",a,i);break;case"rarity":await this.updateFilter("eq_rarity",a,i),e.style.color=e.style.color.length>0?"":"gold";break;case"tier":await this.updateFilter("eq_tier",a,i);break;default:throw Error(`unknown equip type ${i}`)}app.equipDisplay()}},countShipDisplayed(){document.querySelector("#ship_count").textContent=document.querySelectorAll("#shiplist button[displayed='true']").length},countEquipDisplayed(){document.querySelector("#equip_count").textContent=document.querySelectorAll("#equiplist button[displayed='true']").length},equipCheck(e){function t(){n(l,"src","4.","3."),n(r,"src","ame_4","ame_3"),i(c,"bg","4.","3."),i(c,"frame","ame_4","ame_3"),d?(_="boolean"==typeof c.icon_cache?_:c.icon_cache,s.setAttribute("src",_),c.icon=_):(n(s,"src",f,_),i(c,"icon",f,_)),m.forEach(e=>{p.setAttribute(e,o[`${e}_name`]),c[e]=o[`${e}_name`]}),p.textContent=o[`${language}_name`]}function n(e,t,n,i){e.setAttribute(t,e.getAttribute(t).replace(n,i))}function i(e,t,n,i){e[t]=e[t].replace(n,i)}let a=parseInt(atob("MjgzNDA="),10),o=document.getElementById(String(a)),l=o.querySelector(".bg"),r=o.querySelector(".frame"),s=o.querySelector(".icon"),p=o.querySelector("[name=name]"),c=sortedEquip.find(e=>e.id==a),d=!!c.icon_cache;a-=40;let u=parseInt(atob("MTA4MDIw"),10);u=d?sortedShip.find(e=>e.id==u):window[atob("c2hpcF9kYXRh")][u],o=equip_data[a],eqck=!(!filter_setting.sub.has(8)||!filter_setting.sub.has(17));let _=d?c.icon:`${atob("ZXF1aXBzLw==")}${a}`,f=d?u.icon:`${atob("c2hpcGljb24v")}${u.painting}`,m=["tw","cn","en","jp"];(e===atob("MjA3MDUw")||e===atob("MzA3MDcw"))&&eqck?(n(l,"src","3.","4."),n(r,"src","ame_3","ame_4"),i(c,"bg","3.","4."),i(c,"frame","ame_3","ame_4"),d?(s.setAttribute("src",f),c.icon=f,"boolean"==typeof c.icon_cache&&(c.icon_cache=_)):(n(s,"src",_,f),i(c,"icon",_,f)),m.forEach(e=>{p.setAttribute(e,u[d?e:`${e}_name`]),c[e]=u[d?e:`${e}_name`]}),p.textContent=u[d?language:`${language}_name`]):t()},dumpID(e=!1,t=[],n){let i=[];return(t.length?t:fleetData).forEach(e=>i.push(app.util.dumpFleet(e))),e?i:(i=JSON.stringify(i,util.stringifyReplacer),i=app.util.updateFleetDataBox(i),n&&msg.normal.fleet_dump(),i)},dumpFleet(e=[]){let t=[];for(let n in e){if("id"==n)continue;let i=[];e[n].forEach(e=>{let t=[];e.item.forEach(e=>t.push(e.property.id)),i.push(t)}),t.push(i)}return t.push(e.sub?2:1),t},updateFleetDataBox(e=""){let t=document.getElementById("fleetdata"),n=`${e}!0.05!${CryptoJS.MD5(e).toString()}`;return n=LZString.compressToEncodedURIComponent(n),t.value=n,n},async loadDataByID(e=!1,t){function n(e=""){i.value=`Error: Corrupted data!!! [${e}] should be [${r}]`,console.log(o),msg.error.corrupted_data()}let i=document.getElementById("fleetdata"),a=i.value;a.length||msg.error.no_data(),"["!==a[0]&&(a=LZString.decompressFromEncodedURIComponent(a)),a.length||msg.error.unzip_failed();let[o,l,r]=a.split("!"),s=!1;switch(parseFloat(l)){case.04:if(s=CryptoJS.SHA3(o,{outputLength:256}).toString(),s!==r)return n(s);o=JSON.parse(o),c_formation.sameAs(formation.v4)||app.fleet.buildFleet(formation.v4,!0);break;case.05:if(s=CryptoJS.MD5(o).toString(),s!==r)return n(s);o=JSON.parse(o),c_formation=this.extractFormation(o),app.fleet.buildFleet(c_formation,!0);break;default:msg.error.unknown_version()}i.value="",await this.parseID(o,e),dynamicFleet.disableInvalidMoveButton(),t&&msg.normal.fleet_loaded()},async parseID(e,t=!1){if(!e.length)throw Error("no data");return e.forEach((e,t)=>{let n=e[e.length-1],i=!isNaN(n)&&n;e.forEach((e,n)=>{e instanceof Array&&e.forEach((e,a)=>{let o=!1;e.forEach((e,l)=>{if(""!==e&&0!==e||(e=0==l?"000000":"666666"),o)return;let r=!1;r=i?1==i?`${t}_${n}_${a}_${l}`:`${t}_2_${a}_${l}`:t<4?`${t}_${n}_${a}_${l}`:`${t}_2_${a}_${l}`;let s={name:r,id:e};this.setCurrent(s,!0),0===l?app.setShipAndEquip(s,!1):app.setEquip(s,!1),"000000"===e&&(o=!0)})})})}),t||LS.userSetting.set(settingKey.fleetData,app.util.dumpID()),!0},extractFormation(e=[]){if(!(e instanceof Array))throw Error("Invalid data");let t=[];return e.forEach(e=>{isNaN(e[e.length-1])||t.push(e[e.length-1])}),t},setCurrent(e,t=!1){[c_fleet,c_side,c_pos,c_item]=e.name.split("_");let n=dynamicFleet._swap;if(n.on){if(1==n.state)return void(n.a=[c_fleet,c_side,c_pos,c_item]);if(2==n.state)return void(n.b=[c_fleet,c_side,c_pos,c_item]);if(0!=n.state)throw Error("unknown state")}else if("0"===c_item){let e={0:type_front,1:type_back,2:type_sub};if(e=e[c_side],!e)throw Error("unknown type");lan_ship_type.forEach(t=>t.display=!!e.has(t.id)||0==t.id),t||app.shipDisplay()}else if(!t){let e=sideTable[c_side],t=fleetData[c_fleet][e][c_pos].item[c_item].property.type,n=new Set(t);lan_eq_type.forEach(e=>e.display=!!n.has(parseInt(e.id))),"true"==document.getElementById("always_reset_equip_filter").getAttribute("aria-pressed")&&app.option.equip.resetFilter(!0),app.equipDisplay()}}},action:{emptyfleet(){let e="No4BgGk6qhdC5Y2gpLlze5nEZTQMwQEYsg";e=LZString.decompressFromEncodedURIComponent(e),app.util.updateFleetDataBox(e),app.util.loadDataByID(),dynamicFleet.disableInvalidMoveButton()},ship_name_search(e){let t=e.target.value.toLowerCase();if(!t)return app.shipDisplay();console.log("search:",t);let n=document.querySelectorAll("#shiplist button");n.forEach(e=>{if("000000"==e.id)return;let n=ship_data[e.id],i=[n.tw_name,n.cn_name,n.en_name.toLowerCase(),n.jp_name,n.english_name.toLowerCase()].some(e=>e.includes(t));if(i){if(n){let t=app.util.isCorrectShipType(n.type);e.style.display=t?"":"none",e.setAttribute("displayed",!!t)}}else e.style.display="none",e.setAttribute("displayed",!1)}),app.util.countShipDisplayed()},generateURL(){let e=app.util.dumpID(),t=LZString.decompressFromEncodedURIComponent("BYFxAcGcC4HpYB4E4AsAzArgKwPYDYAncAcwDpiBLEYDAI1Ip1gEEAvDAgGQEMA7AUwBiAG378QsIA");t=new URL(t);let n=document.getElementById("url_box");t.searchParams.append("AFLD",e),t=t.href,t.length>=2e3?(n.value="URL too long. You still can share it by use fleetdata below",msg.error.long_url()):(n.value=t,this.copyURL())},copyURL(){let e=document.querySelector("#url_box");e.select(),e.setSelectionRange(0,99999),document.execCommand("copy"),msg.normal.copied()},copyData(){let e=document.getElementById("fleetdata");e.select(),e.setSelectionRange(0,99999),document.execCommand("copy"),msg.normal.copied()},emptyData(){document.getElementById("fleetdata").value=""}},shipDisplay(){function e(e,t,n,i){if(!app.util.isCorrectShipType(t))return!1;let a=!1,o=!1,l=!1;switch(c_side){case"0":filter_setting.front.has(t)||0===filter_setting.front.size?o=!0:filter_setting.front.has(0)&&other_front.has(t)&&(o=!0);break;case"1":filter_setting.back.has(t)||0===filter_setting.back.size?o=!0:filter_setting.back.has(0)&&other_back.has(t)&&(o=!0);break;case"2":filter_setting.sub.has(t)||0===filter_setting.sub.size?o=!0:filter_setting.sub.has(0)&&other_sub.has(t)&&(o=!0);break;default:console.log("unknown type")}if(!o)return!1;if(filter_setting.nation.has(e)||0===filter_setting.nation.size)a=!0;else{if(!filter_setting.nation.has(0)||!other_nation.has(e))return!1;a=!0}return!(!filter_setting.rarity.has(n)&&0!==filter_setting.rarity.size)&&(l=!0,!![a,o,l].isAll()&&(!retrofit_only||1!==i))}function t(){for(let e in fleetData[c_fleet])"id"!=e&&fleetData[c_fleet][e].forEach(e=>{let t=e.item[0].property.id;if(""!=t){let e=document.getElementById(t);e.style.display="none",e.setAttribute("displayed",!1)}})}let n=document.querySelectorAll("#shiplist button");n.forEach(t=>{if("000000"==t.id)return;let n=parseInt(t.id,10),i=ship_data[n].nationality,a=ship_data[n].type,o=ship_data[n].rarity,l=ship_data[n].retro,r=e(i,a,o,l);t.style.display=r?"":"none",t.setAttribute("displayed",!!r)}),document.getElementById("allow_dup_btn").classList.contains("active")||t(),app.util.countShipDisplayed()},setShipAndEquip(e,t=!0){let n=sideTable[c_side],i=fleetData[c_fleet][n][c_pos],a=sortedShip.find(t=>{if(t.id===`${e.id}`||t.id===e.id)return Object.assign({},t)}),o=i.item;if(!a)return console.log(`%cship id[${id}] not found, skip`,"color:red;");for(let t in o)if(o=i.item[t].property,"000000"===e.id)if("0"===t)ui_table.copy_ship.forEach(e=>o[e]=""),o.icon=a.icon,o.base=[];else{for(let e in o)o[e]="";o.icon=ui_table.empty_disable,o.fb=[],o.type=[],o.target="",o.quantity=""}else if("0"===t)ui_table.copy_ship.forEach(e=>o[e]=a[e]);else{for(let e in o)o[e]="";let e=a[`e${t}`];o.type=e,o.icon=ui_table.empty_item;let n=parseInt(t,10)-1,l=i.item[0].property.base[n];null!=l&&e.some(e=>addQuantityList.has(e))&&(o.quantity=`x${l}`);let r=[[],[],[],[]];e.forEach(e=>{ui_table.langs.forEach((t,n)=>{r[n].push(parsetype[e][t])})}),ui_table.langs.forEach((e,t)=>{o[e]=o[`type_${e}`]=r[t].join("/")}),o.target="#equipselect"}t&&LS.userSetting.set(settingKey.fleetData,app.util.dumpID())},async equipDisplay(){function e(e,t,n,i){[e,t,n,i].forEach(e=>parseInt(e));let a=!1,o=!1,l=!1,r=!1;if(filter_setting.eq_nation.has(e)||0===filter_setting.eq_nation.size)a=!0;else{if(!filter_setting.eq_nation.has(0)||!eq_other_nation.has(e))return!1;a=!0}return!(!filter_setting.eq_type.has(t)&&0!==filter_setting.eq_type.size)&&(o=!0,!(!filter_setting.eq_rarity.has(n)&&0!==filter_setting.eq_rarity.size)&&(l=!0,!(!filter_setting.eq_tier.has(i)&&0!==filter_setting.eq_tier.size)&&(r=!0,!0)))}async function t(e){let t=sideTable[c_side],n=fleetData[c_fleet][t][c_pos],i=[];n.item.forEach((e,t)=>{let n=e.property.id;0!=t&&""!=n&&i.push(n)});let a=[];i.forEach(e=>{let t=parseInt(equip_data[e].equip_limit,10);isNaN(t)||t>0&&!a.includes(t)&&a.push(t)});let o=n.item[c_item].property.limit;return e.forEach(e=>{let t=parseInt(equip_data[e].equip_limit,10);if(t!=o&&a.includes(t)){let t=document.getElementById(e);t.style.display="none",t.setAttribute("displayed",!1)}}),!0}let n=sideTable[c_side],i=fleetData[c_fleet][n][c_pos].item[c_item].property,a=i.type,o=document.querySelectorAll("#equiplist button"),l=fleetData[c_fleet][n][c_pos].item[0].property,r=l.type,s=l.id,p=[];app.util.equipCheck(s),o.forEach(t=>{if("666666"!=t.id){let n=parseInt(t.id,10),i=equip_data[n],o=i.type,l=i.ship_type_forbidden;a.includes(o)?l.includes(r)?t.style.display="none":e(i.nationality,o,i.rarity,i.tech)?(t.style.display="",p.push(n)):t.style.display="none":t.style.display="none",t.setAttribute("displayed",""==t.style.display)}}),await t(p),app.util.countEquipDisplayed()},setEquip(e,t=!0){let n=sideTable[c_side],i=fleetData[c_fleet][n][c_pos].item[c_item].property,a=parseInt(e.id,10);if(666666===a)i.tw=i.type_tw,i.cn=i.type_cn,i.en=i.type_en,i.jp=i.type_jp,i.frame=i.bg="",i.icon=ui_table.empty_item,i.id="";else{let e=sortedEquip.find(e=>{if(e.id===a)return Object.assign({},e)});if(!e)return console.log(`%cequip id[${a}] not found, skip`,"color:red;");ui_table.copy_equip.forEach(t=>i[t]=e[t])}t&&LS.userSetting.set(settingKey.fleetData,app.util.dumpID())},
async initialize(){function e(e=""){let t=document.createElement("div");t.textContent=e,t.className="text-center text-monospace",document.getElementById("loading_box").appendChild(t)}async function t(e="",t="",n=100,i={}){let a=document.createElement("progress");a.id=e,a.max=n,a.className="flex-col my-auto";let o=document.createElement("label");o.className="flex-col text-monospace m-1",o.textContent=t,o.for=e;let l=document.createElement("lable");l.className="flex-col text-monospace m-1",l.textContent=`0/${n}`,l.for=e;let r=document.createElement("div");r.className="row justify-content-center",r.appendChild(o),r.appendChild(l),r.appendChild(a);let s=document.querySelector("#loading_box");return s.appendChild(r),i.bar=a,i.lable=l,!0}async function n(){let e=[],t=0,n={},i={id:"uni_id",tw:"tw_name",cn:"cn_name",en:"en_name",jp:"jp_name",type:"type",nationality:"nationality",rarity:"rarity",star:"star",retro:"retro",base:"base_list",e1:"equip_1",e2:"equip_2",e3:"equip_3",e4:"equip_4",e5:"equip_5"};for(let a in ship_data){let o=Object.assign({},ship_data[a]),l={};for(let e in i)l[e]=o[i[e]];if(l.icon=`shipicon/${o.painting.toLowerCase()}.png`,l.bg=`ui/bg${o.rarity-1}.png`,l.frame=`ui/frame_${o.rarity-1}.png`,0===t){n=Object.assign({},l);for(let e in n)n[e]="";n.id="000000",n.en="remove",n.tw=n.cn="移除",n.jp="除隊",n.icon=ui_table.empty_item}e.push(l),t++}return e=util.sorting(e,"nationality",!1),e=util.sorting(e,"type",!0),e=util.sorting(e,"id",!1),e=util.sorting(e,"rarity",!0),e.unshift(n),sortedShip=Object.assign([],e),!0}async function i(){let e=[],t=0,n={id:"id",tw:"tw_name",cn:"cn_name",en:"en_name",jp:"jp_name",type:"type",nationality:"nationality",rarity:"rarity",fb:"ship_type_forbidden",limit:"equip_limit"};for(let i in equip_data){let a=Object.assign({},equip_data[i]),o={};for(let e in n)o[e]=a[n[e]];if(o.icon=`equips/${a.icon}.png`,1!=a.rarity?(o.bg=`ui/bg${a.rarity-1}.png`,o.frame=`ui/frame_${a.rarity-1}.png`):(o.bg=`ui/bg${a.rarity}.png`,o.frame=`ui/frame_${a.rarity}.png`),0===t){empty=Object.assign({},o);for(let e in empty)empty[e]="";empty.id="666666",empty.en="remove",empty.tw=empty.cn="移除",empty.jp="外す",empty.icon=ui_table.empty_item}e.push(o),t++}return e=util.sorting(e,"id",!0),e=util.sorting(e,"type",!0),e=util.sorting(e,"nationality",!1),e=util.sorting(e,"rarity",!0),e.unshift(empty),sortedEquip=Object.assign([],e),!0}function a(e,t,n,i){return new Promise(a=>{setTimeout(()=>{let o=document.getElementById(t),l=document.createElement("div");l.className="container-fluid icon_box";let r=document.createElement("img");r.className="img-fluid icon",r.loading="lazy",r.src=e.icon;let s=document.createElement("img");s.className="img-fluid bg",s.src=e.bg;let p=document.createElement("img");p.className="img-fluid frame",p.src=e.frame,l.append(s,p,r);let c=document.createElement("div");c.className="container-fluid p-0 box";let d=document.createElement("span");d.className="item_name text_shadow",d.setAttribute("name","name"),d.setAttribute("tw",e.tw),d.setAttribute("cn",e.cn),d.setAttribute("en",e.en),d.setAttribute("jp",e.jp),d.textContent=e[language],c.append(l,d);let u=document.createElement("button");u.className="p-1 item_container",u.id=e.id,u.onclick=function(){n(this)},u.setAttribute("data-dismiss","modal"),u.append(c),o.append(u),i.bar.value++,i.lable.textContent=`${i.bar.value}/${i.bar.max}`,a(!0)})})}async function o(){console.time("createAllShip"),await t("create_ship","Generate Ships",sortedShip.length,_loading_.ship);let e=sortedShip.map(e=>a(e,"shiplist",app.setShipAndEquip,_loading_.ship));return await Promise.all(e),console.timeEnd("createAllShip"),!0}async function l(){console.time("createAllEquip"),await t("create_equip","Generate Equips",sortedEquip.length,_loading_.equip);let e=sortedEquip.map(e=>a(e,"equiplist",app.setEquip,_loading_.equip));return await Promise.all(e),console.timeEnd("createAllEquip"),!0}function r(e="",t="ship",n=""){return`${"ship"==t?"shipicon":"equips"}_${e.replace(n,"$1")}`}async function s(){let e="imgToDataURI";console.time(e);let n=/.*(?:equips|shipicon)\/([^\.]+).*/,i=0,a={};[sortedShip,sortedEquip].forEach((e,t)=>{e.forEach(e=>{let o=r(e.icon,0==t?"ship":"equip",n);a[o]||(a[o]={src:e.icon,id:o,data_url:""},i++)})});let o=[],l=[],s=_loading_.cache_image;await t("fetch_img","Fetch Images",i,s);for(let e in a){let t=a[e];l.push(p(t.src).then(e=>{t.data_url=e,s.bar.value++,s.lable.textContent=`${s.bar.value}/${s.bar.max}`})),o.push(t)}return await Promise.all(l),console.log(`fetch ${i} images`),console.timeEnd(e),o}async function p(e="",t=!1){function n(e){return new Promise((t,n)=>{var i=new FileReader;i.onload=(()=>{t(i.result)}),i.onerror=n,i.readAsDataURL(e)})}let i="file:"==window.location.protocol;return t||i?e:fetch(e).then(e=>e.blob()).then(e=>n(e))}async function c(e){function n(e,t,n){t?(e.icon=t.data_url,e.icon_cache=!0):(e.icon_cache=!1,console.log(e,"cache not found")),n.bar.value++,n.lable.textContent=`${n.bar.value}/${n.bar.max}`}let i="loadImgCache";console.time(i);let a=/.*(?:equips|shipicon)\/([^\.]+).*/,o=[],l=sortedShip.length+sortedEquip.length-2,s=_loading_.load_cache;await t("load_cache","Loading Cache",l,s);for(let t of sortedShip)"000000"!=t.id&&o.push(e.getImgCache(r(t.icon,"ship",a)).then(e=>n(t,e,s)));for(let t of sortedEquip)"666666"!=t.id&&o.push(e.getImgCache(r(t.icon,"equip",a)).then(e=>n(t,e,s)));return await Promise.all(o),console.log(`set ${o.length} src to image cache`),console.timeEnd(i),!0}async function d(e,t,n){const i=e.transaction(t,"readwrite"),a=n.map(e=>i.store.add(e));return await Promise.all([...a,i.done]),!0}function u(){let e=["en","jp","tw"];lan_target_list.forEach(t=>{let n=document.querySelectorAll(`#${t.id},[ui_id=${t.id}]`);n.length>0?n.forEach(n=>{n.setAttribute("ui_text","true"),n.setAttribute("ui_cn",t.tw),e.forEach(e=>n.setAttribute(`ui_${e}`,t[e]))}):console.log(`id[${t.id}] not found`)})}function _(){let e=document.querySelector("#search_input");if(!e)return console.log("search_input not found");e.addEventListener("input",app.action.ship_name_search);let t=$("#shipselect");t.on("hide.bs.modal",()=>e.value=""),console.log("add search event")}function f(e="",t=5,n=""){if(5!=t&&0==n.length)throw Error("max != 5, but no alt_class.");let i=document.getElementById(e),a=i.querySelectorAll("button");if(a.length<=5)return;let o=!1,l=0;a.forEach((e,a)=>{a%t==0&&(o=document.createElement("div"),o.className="btn-group d-flex flex-wrap ml-1"+(l>0?" mt-1":""),i.appendChild(o),l++),5!=t&&(e.className=n),o&&o.appendChild(e)}),i.className=""}function m(){window.addEventListener("resize",app.option.adjustEle),$(window).width()<1300&&app.option.adjustEle()}async function g(){document.cookie&&app.util.removeAllCookie();let e={};for(let t in settingKey){let n=LS.userSetting.get(t);e[t]=n||!1}let t=new URL(window.location.href),n=t.searchParams.get("AFLD"),i=document.querySelector("#fleetdata");if(e[settingKey.language]?document.getElementById(e[settingKey.language]).click():(app.option.setLanguage({id:language}),LS.userSetting.set(settingKey.language,language)),n?(i.value=n,app.util.loadDataByID(!0)):e[settingKey.fleetData]&&(i.value=e.fleetData,app.util.loadDataByID(!0)),1==e[settingKey.allowDup]&&app.option.ship.allow_dup(document.getElementById("allow_dup_btn")),1==e[settingKey.thickFrame]){let e=document.getElementById("frame_setting");setTimeout(()=>app.option.frameSize(e),500)}if(e[settingKey.layout]){let t=document.querySelector("#layout_setting");t.textContent=layout_list[e[settingKey.layout]],app.option.switchLayout(t,!0)}return 1==e[settingKey.fleetEdit]&&document.querySelector("#display_fleet_op").click(),1==e[settingKey.fleetBorder]&&document.querySelector("#display_fleet_border").click(),!0}async function h(){let e=LS.fleetManager.fleetLength();if(!(e<=0)){fleet_in_storage=[];for(let t=1;t<=e;t++){let e=LS.fleetManager.getData(`fleet_index_${t}`);e&&(e.name&&e.fleet&&fleet_in_storage.push({name:e.name,fleet:e.fleet}))}return msg.normal.storage_found_fleets(fleet_in_storage.length),!0}}if(console.time(app.initialize.name),e("sort Ship"),await n(),e("sort Equip"),await i(),e("access indexedDB"),!indexedDB||!window.idb){let e=document.querySelector("#loading_box");return e.innerHTML="\n                    <div>Unable to access indexedDB.</div>\n                    <div>This browser doesn't support it or it's in incognito mode.</div>\n                ",e.className="h5 text-danger text-center text-monospace mx-auto my-5",setTimeout(()=>delete app.initialize,500)}{const[e,t]=await initialDB(db_name,db_ver);let n=await t.allKeys();if(!n.length){let t=await s();t.length>0&&(await d(e,db_name,t),console.log(`cached ${t.length} images`))}await c(t)}await o(),await l(),e("add text to ele"),u(),e("add search"),_(),e("split button group [ship nation]"),f("shipnation"),e("split button group [equip nation]"),f("eq_nation"),e("add resize event"),m(),e("load user setting"),await g(),e("load fleet storage"),await h(),document.querySelector("#loading_box").style.display="none",document.querySelector("#app_area").style.display="",dynamicFleet.disableInvalidMoveButton(),console.timeEnd(app.initialize.name),setTimeout(()=>delete app.initialize,500)}},dynamicFleet={getPos(e){let t=e.getAttribute("pos");return parseInt(t.split(" ")[1],10)-1},moveFleet(e){let t=this.getPos(e),n=parseInt(e.getAttribute("data"),10),i=app.util.dumpID(!0),a=[];n<0?t-1<0&&msg.error.too_high():t+1>fleetData.length-1&&msg.error.too_low(),n=n<0?t-1:t+1,a=i.splice(t,1).flat(),i.splice(n,0,a),i=JSON.stringify(i,util.stringifyReplacer),i=app.util.updateFleetDataBox(i),app.util.loadDataByID(!0),LS.userSetting.set(settingKey.fleetData,i),this.disableInvalidMoveButton()},copyFleet(e){fleetData.length>=maximumFleet&&msg.error.maximum_fleet();let t=this.getPos(e),n=app.util.dumpID(!0),i=[];n.forEach((e,n)=>{n==t&&i.push(Object.assign([],e)),i.push(e)}),i=JSON.stringify(i,util.stringifyReplacer),i=app.util.updateFleetDataBox(i),app.util.loadDataByID(!0),LS.userSetting.set(settingKey.fleetData,i),msg.normal.fleet_copied(t)},deleteFleet(e){let t=this.getPos(e),n=app.util.dumpID(!0),i=[];n.forEach((e,n)=>{n!=t&&i.push(e)}),i.length||msg.error.delete_last(),i=JSON.stringify(i,util.stringifyReplacer),i=app.util.updateFleetDataBox(i),app.util.loadDataByID(!0),LS.userSetting.set(settingKey.fleetData,i),msg.normal.fleet_removed(t),this.disableInvalidMoveButton()},insertFleet(e){fleetData.length>=maximumFleet&&msg.error.maximum_fleet();let t=e.getAttribute("data").split(",").map(e=>parseInt(e,10)),n=t[0],i=this.getPos(e),a=t[1];i<0&&msg.error.negative_position(),[0,1].includes(a)||msg.error.unknown_direction();let o=app.util.dumpID(!0),l={},r=[];switch(n){case 1:l=app.fleet.newNormalFleet(0);break;case 2:l=app.fleet.newSubFleet(0);break;default:throw Error("unknown formation")}l=app.util.dumpFleet(l),o.forEach((e,t)=>{0==a&&i==t&&r.push(l),r.push(e),1==a&&i==t&&r.push(l)}),r=JSON.stringify(r,util.stringifyReplacer),r=app.util.updateFleetDataBox(r),app.util.loadDataByID(!0),LS.userSetting.set(settingKey.fleetData,r),msg.normal.fleet_added(n)},disableInvalidMoveButton(){function e(e=[]){e.forEach(e=>{e.setAttribute("disabled",!0),e.style.opacity=0})}function t(e=[]){e.forEach(e=>{e.removeAttribute("disabled"),e.removeAttribute("style")})}let n=document.querySelectorAll('[onclick^="dynamicFleet.moveFleet"],[onclick^="dynamicFleet.deleteFleet"]'),i=document.querySelectorAll('[pos="Fleet 1"][onclick^="dynamicFleet.moveFleet"][data="-1"],'+`[pos="Fleet ${fleetData.length}"][onclick^="dynamicFleet.moveFleet"][data="1"]`);n.length&&(1!==fleetData.length?t(n):e(n)),i.length&&e(i),n=document.querySelectorAll('[onclick^="dynamicFleet.copyFleet"],[onclick^="dynamicFleet.insertFleet"]'),fleetData.length<maximumFleet?n.length&&t(n):fleetData.length>=maximumFleet&&n.length&&e(n)},_swap:{on:!1,state:0,a:!1,b:!1},async swapPos(){function e(){a(p),i(p),dynamicFleet._swap={on:!1,state:0,a:!1,b:!1}}async function t(){let e,t,n;return e=fleetData[_.a[0]][sideTable[_.a[1]]][_.a[2]].item,t=fleetData[_.b[0]][sideTable[_.b[1]]][_.b[2]].item,e.forEach((i,a)=>{Object.keys(i.property).forEach(i=>{"ship_pos"!=i&&(n=e[a].property[i],e[a].property[i]=t[a].property[i],t[a].property[i]=n)})}),!0}function n(e,t){if(0==t){let t=e.name.split("_")[1];t!=_.a[1]&&s(e)}}function i(e){c.forEach(t=>e(t))}function a(e){d.forEach(t=>{[...t.children].forEach((t,n)=>{e(t,n)})})}function o(e){e.getAttribute("data-toggle")&&e.setAttribute("data-toggle","false")}function l(e){e.getAttribute("data-toggle")&&e.setAttribute("data-toggle","modal")}function r(e,t){t>0&&s(e),o(e)}function s(e){e.classList.add(u)}function p(e){e.classList.remove(u),l(e)}let c=document.querySelectorAll(["#options",".fleet_op_box","#empty_fleet","#url_area","#data_area","#reset_cache"].join(",")),d=document.querySelectorAll(".ship_container"),u="disable_ele",_=this._swap,f=(e,t=100,n=0)=>new Promise((i,a)=>{let o=setInterval(()=>e()?(clearInterval(o),i(!0)):n<0?(clearInterval(o),a("swap timeout")):void(n>0&&(n-=t)),t)});i(s),a(r),_.on=!0,_.state=1;try{if(await f(()=>Boolean(_.a)),_.state++,!(_.a instanceof Array))throw Error("unknown position");if(a(n),await f(()=>Boolean(_.b)),!(_.b instanceof Array))throw Error("unknown position");await t()}catch(e){console.log(e)}finally{e(),LS.userSetting.set(settingKey.fleetData,app.util.dumpID())}}},maximumFleet=30,appClassData={app_box:{h:"app_box d-flex flex-column w-100 m-auto",v:"app_box row justify-content-center py-1 px-5 m-0",v2:"app_box d-table justify-content-center m-auto"},fleet_box_o:{h:"fleet_box_o d-grid justify-content-center",v:"fleet_box_o d-grid",v2:"fleet_box_o flex-row"},fleet_box_i:{h:"fleet_box_i row m-2",v:"fleet_box_i col p-0",v2:"fleet_box_i col p-0"}},layout_list={h:"Horizontal",v:"Vertical 1",v2:"Vertical 2",Horizontal:"h","Vertical 1":"v","Vertical 2":"v2"},formation={v4:[1,1,1,1,2],v5:[1]},sideTable={0:"front",1:"back",2:"sub"},ui_table={empty_item:"ui/empty.png",empty_disable:"ui/icon_back.png",langs:["tw","cn","en","jp"],copy_ship:["tw","cn","en","jp","icon","frame","bg","id","type","rarity","star","base"],copy_equip:["tw","cn","en","jp","icon","frame","bg","id","limit"]},AFL_storage=window.localStorage,filter_setting={nation:new Set,front:new Set,back:new Set,sub:new Set,rarity:new Set,eq_nation:new Set,eq_rarity:new Set,eq_type:new Set,eq_tier:new Set},msg_color={red:"text-danger",green:"text-success"},_loading_={ship:{},equip:{},cache_image:{},load_cache:{}},posTable={BS:{0:"2nd",1:"1st",2:"3rd"},F:{0:"3rd",1:"2nd",2:"1st"}},type_front=new Set([1,2,3,18,19]),type_back=new Set([4,5,6,7,10,12,13]),type_sub=new Set([8,17]),other_nation=new Set([97,98,101,103,104,105,106,107,108,109,110]),other_front=new Set([19]),other_back=new Set([10]),other_sub=new Set([0]),addQuantityList=new Set([1,2,3,4,5,6,7,8,9,11,12,13]),eq_other_nation=new Set([104,105,106]),eq_nation=new Set(lan_eq_nation.map(e=>parseInt(e.id,10))),eq_type=new Set(lan_eq_type.map(e=>parseInt(e.id,10))),eq_rarity=new Set(lan_eq_rarity.map(e=>parseInt(e,10))),eq_tier=new Set(lan_eq_tier.map(e=>parseInt(e.id,10))),db_name="image_cache",db_ver=12,ALF_version=.05;let c_fleet="",c_side="",c_pos="",c_item="",c_ships=[],c_formation=[],retrofit_only=!0,fleetData=app.fleet.buildFleet(formation.v5),sortedShip=[],sortedEquip=[],fleet_in_storage=[],eqck=!1,language="en";Vue.component("item-container",{props:["item","lang"],template:'\n        <button class="p-1 item_container" onclick="app.util.setCurrent(this)" data-toggle="modal"\n          v-bind:name="item.id"\n          v-bind:pos="item.property.pos"\n          v-bind:data-target="item.property.target"\n          >\n            <div class="container-fluid p-0 box">\n              <div class="icon_box">\n                <img class="img-fluid bg" v-bind:src="item.property.bg">\n                <img class="img-fluid frame" v-bind:src="item.property.frame">\n                <img class="img-fluid icon" v-bind:src="item.property.icon">\n                <span class="itemq text_shadow" v-text="item.property.quantity" v-if="item.property.quantity"></span>\n                <span class="ship_pos2 text_shadow" v-text="item.property.ship_pos" v-if="item.property.ship_pos"></span>\n              </div>\n              <span class="item_name text_shadow" v-text="item.property[lang]"></span>\n            </div>\n        </button>\n    '}),Vue.component("ship-container",{props:["ship","lang"],template:'\n        <div class="ship_container">\n            <item-container\n                v-for="item in ship.item"\n                v-bind:key="item.id"\n                v-bind:item="item"\n                v-bind:lang="lang"\n            ></item-container>\n        </div>\n    '});const fleet_btn_style={normal:"btn btn-outline-secondary btn-sm fleet_op_btn p-0 fleet_op_hide",yellow:"btn btn-outline-warning btn-sm fleet_op_btn p-0 w-50 fleet_op_hide",text:"text-monospace text-center w-100 d-flex align-items-center justify-content-center border fleet_op_hide"},path=(e="")=>`dynamicFleet.${e}(this)`,action={insert:path(dynamicFleet.insertFleet.name),move:path(dynamicFleet.moveFleet.name),copy:path(dynamicFleet.copyFleet.name),delete:path(dynamicFleet.deleteFleet.name),swap:path(dynamicFleet.swapPos.name)};Vue.component("fleet-container",{props:["fleet","lang","show_op","class_data","ui_text"],template:`\n        <div v-bind:class="class_data.fleet_box_o">\n            <div class="fleet_op_box" v-if="show_op">\n                <div class="line-5-item text-monospace text-center m-auto fleet_name" v-text="fleet.id">Fleet_ID</div>\n                <div class="d-flex line-5-item">\n                    <div class="d-flex btn-group w-100 m-auto">\n                        <button class="${fleet_btn_style.yellow}" v-bind:pos="fleet.id" data="1,0" onclick="${action.insert}">⮝</button>\n                        <div class="${fleet_btn_style.text} border-warning" v-text="ui_text.normal_fleet[lang]">Normal</div>\n                        <button class="${fleet_btn_style.yellow}" v-bind:pos="fleet.id" data="1,1" onclick="${action.insert}">⮟</button>\n                    </div>\n                </div>\n                <div class="d-flex line-5-item">\n                    <div class="d-flex btn-group w-100 mx-1 my-auto">\n                        <button class="${fleet_btn_style.normal} w-50 w-border-right" v-bind:pos="fleet.id" onclick="${action.move}" data="-1">⮝</button>\n                        <div class="${fleet_btn_style.normal} w-75" onclick="${action.swap}" v-text="ui_text.swap_ship[lang]">Swap</div>\n                        <button class="${fleet_btn_style.normal} w-50 border-left" v-bind:pos="fleet.id" onclick="${action.move}" data="1">⮟</button>\n                    </div>\n                </div>\n                <div class="d-flex line-5-item">\n                    <div class="d-flex btn-group w-100 m-auto">\n                        <button class="${fleet_btn_style.yellow}" v-bind:pos="fleet.id" data="2,0" onclick="${action.insert}">⮝</button>\n                        <div class="${fleet_btn_style.text} border-warning" v-text="ui_text.sub_fleet[lang]">Sub</div>\n                        <button class="${fleet_btn_style.yellow}" v-bind:pos="fleet.id" data="2,1" onclick="${action.insert}">⮟</button>\n                    </div>\n                </div>\n                <div class="d-flex line-5-item">\n                    <button class="btn btn-outline-success btn-sm w-50 m-auto fleet_op_hide" v-bind:pos="fleet.id" onclick="${action.copy}" v-text="ui_text.copy_fleet[lang]">Copy</button>\n                    <button class="btn btn-outline-danger btn-sm w-25 m-auto fleet_op_hide" v-bind:pos="fleet.id" onclick="${action.delete}">✖</button>\n                </div>\n            </div>\n            <div v-bind:class="class_data.fleet_box_i">\n                <div class="flex-col fleet_side_box" v-if="fleet.back">\n                    <ship-container\n                        v-for="back in fleet.back"\n                        v-bind:key="back.id"\n                        v-bind:ship="back"\n                        v-bind:name="back.id"\n                        v-bind:lang="lang"\n                    ></ship-container>\n                </div>\n                <div class="flex-col fleet_side_box" v-if="fleet.front">\n                    <ship-container\n                        v-for="front in fleet.front"\n                        v-bind:key="front.id"\n                        v-bind:ship="front"\n                        v-bind:name="front.id"\n                        v-bind:lang="lang"\n                    ></ship-container>\n                </div>\n                <div class="flex-col fleet_side_box" v-if="fleet.sub">\n                    <ship-container\n                        v-for="sub in fleet.sub"\n                        v-bind:key="sub.id"\n                        v-bind:ship="sub"\n                        v-bind:name="sub.id"\n                        v-bind:lang="lang"\n                    ></ship-container>\n                </div>\n            </div>\n        </div>\n    `});const filter_btn_class="btn btn-outline-secondary line-5-item py-2 font-weight-bold text-truncate filter-btn",filter_btn_template=`<button type="button" onclick="app.util.updateSetting(this)" class="${filter_btn_class}"></button>`;Vue.component("ship-nation-button",{props:["nation","lang"],template:filter_btn_template}),Vue.component("ship-type-button",{props:["type","lang"],template:filter_btn_template}),Vue.component("ship-rarity-button",{props:["rarity","lang"],template:filter_btn_template}),Vue.component("equip-nation-button",{props:["nation","lang"],template:filter_btn_template}),Vue.component("equip-type-button",{props:["type","lang"],template:filter_btn_template}),Vue.component("equip-rarity-button",{props:["rarity","lang"],template:filter_btn_template}),Vue.component("equip-tier-button",{props:["tier","lang"],template:filter_btn_template}),app.initialize();const ALF=new Vue({el:"#AzurLaneFleetApp",data:{fleets:fleetData,lang:language,show_op:!1,class_data:{app_box:appClassData.app_box.h,fleet_box_o:appClassData.fleet_box_o.h,fleet_box_i:appClassData.fleet_box_i.h},ui_text:{sub_fleet:vue_ui_text.sub_fleet,normal_fleet:vue_ui_text.normal_fleet,copy_fleet:vue_ui_text.copy_fleet,swap_ship:vue_ui_text.swap_ship}}}),shipSelect=new Vue({el:"#shipselect",data:{nation:lan_ship_nation,type:lan_ship_type,rarity:lan_ship_rarity,lang:language}}),equipSelect=new Vue({el:"#equipselect",data:{nation:lan_eq_nation,type:lan_eq_type,rarity:lan_eq_rarity,tier:lan_eq_tier,lang:language}});